name: Publish Packages

on:
  push:
    branches: [main]
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'services-v[0-9]+.[0-9]+.[0-9]+'
      - 'widgets-v[0-9]+.[0-9]+.[0-9]+'
      - 'design-system-v[0-9]+.[0-9]+.[0-9]+'
      - 'clinical-app-v[0-9]+.[0-9]+.[0-9]+'
      - 'registration-app-v[0-9]+.[0-9]+.[0-9]+'
    paths:
      - 'packages/**'
      - 'apps/**'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  # Detect which packages and apps are affected by the changes (dev releases only)
  detect-affected:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build affected projects with dependencies
        run: |
          # Build all affected projects including their dependencies
          # This ensures all packages are built in correct dependency order
          echo "Building affected projects and their dependencies..."
          yarn build:affected --base=${{ github.event.before }} || echo "No affected projects to build"

      - name: Test affected projects
        run: |
          # Test all affected projects
          echo "Testing affected projects..."
          yarn test:affected --base=${{ github.event.before }} || echo "No affected projects to test"

      - name: Detect affected packages and apps for publishing
        id: set-matrix
        run: |
          # Get all affected projects including their dependents (Nx handles dependency graph)
          AFFECTED_RAW=$(npx nx show projects --affected --base=${{ github.event.before }} 2>/dev/null || echo "")
          
          echo "Affected projects: $AFFECTED_RAW"
          
          # Build matrix JSON directly from affected projects, excluding distro
          MATRIX_JSON="[]"
          
          for PROJECT in $AFFECTED_RAW; do
            # Skip distro and sample-app-module (not publishable)
            if [ "$PROJECT" = "@bahmni/distro" ] || [ "$PROJECT" = "@bahmni/sample-app-module" ]; then
              continue
            fi
            
            # Determine the project path
            if [[ $PROJECT == *"-app" ]]; then
              # It's an app (e.g., @bahmni/clinical-app -> apps/clinical)
              APP_NAME=$(echo "$PROJECT" | sed 's/@bahmni\///' | sed 's/-app//')
              PROJECT_PATH="apps/$APP_NAME"
            else
              # It's a package (e.g., @bahmni/services -> packages/bahmni-services)
              PKG_NAME=$(echo "$PROJECT" | sed 's/@bahmni\///')
              PROJECT_PATH="packages/bahmni-$PKG_NAME"
            fi
            
            echo "Adding $PROJECT to publish matrix (path: $PROJECT_PATH)"
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq --arg name "$PROJECT" --arg path "$PROJECT_PATH" '. + [{"name": $name, "path": $path}]')
          done
          
          # For workflow_dispatch, include all packages and apps if none detected
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$(echo $MATRIX_JSON | jq '. | length')" -eq 0 ]; then
            echo "Workflow dispatch with no affected projects - publishing all"
            MATRIX_JSON='[{"name": "@bahmni/services", "path": "packages/bahmni-services"}, {"name": "@bahmni/design-system", "path": "packages/bahmni-design-system"}, {"name": "@bahmni/widgets", "path": "packages/bahmni-widgets"}, {"name": "@bahmni/clinical-app", "path": "apps/clinical"}, {"name": "@bahmni/registration-app", "path": "apps/registration"}]'
          fi
          
          # Create final matrix with compact JSON output
          MATRIX=$(echo "{\"include\":$MATRIX_JSON}" | jq -c .)
          
          echo "Publish Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Publish packages and apps using matrix strategy
  publish-packages:
    needs: detect-affected
    if: needs.detect-affected.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    environment: npm-publish
    strategy:
      matrix: ${{ fromJson(needs.detect-affected.outputs.matrix) }}
      max-parallel: 1  # Publish one package or app at a time to maintain dependency order
      fail-fast: false
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint ${{ matrix.name }}
        run: npx nx lint ${{ matrix.name }}

      - name: Build ${{ matrix.name }} with dependencies for publishing
        run: npx nx build ${{ matrix.name }} 

      - name: Publish dev build to npm
        working-directory: ${{ matrix.path }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing ${{ matrix.name }}@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published ${{ matrix.name }}@$DEV_VERSION"
          echo "::notice title=Install Command::npm install ${{ matrix.name }}@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"

  # Release stable versions using nx release (triggered by tags)
  release-stable:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Parse tag and determine project
        id: parse-tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG"
          
          # Determine which project to release based on tag name
          if [[ $TAG == services-v* ]]; then
            PROJECT="@bahmni/services"
          elif [[ $TAG == widgets-v* ]]; then
            PROJECT="@bahmni/widgets"
          elif [[ $TAG == design-system-v* ]]; then
            PROJECT="@bahmni/design-system"
          elif [[ $TAG == clinical-v* ]]; then
            PROJECT="@bahmni/clinical-app"
          elif [[ $TAG == registration-v* ]]; then
            PROJECT="@bahmni/registration-app"
          elif [[ $TAG == v* ]]; then
            # Generic version tag - release all projects
            PROJECT="all"
          else
            echo "Unknown tag pattern: $TAG"
            exit 1
          fi
          
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "::notice title=Release Target::Releasing project(s): $PROJECT"

      - name: Run nx release (dry-run)
        run: |
          PROJECT="${{ steps.parse-tag.outputs.project }}"
          
          if [ "$PROJECT" = "all" ]; then
            echo "Running nx release for all projects..."
            npx nx release --dry-run
          else
            echo "Running nx release for $PROJECT..."
            npx nx release --projects=$PROJECT --dry-run
          fi
          
          echo "::notice title=Release Status::Nx release completed successfully (dry-run mode)"
